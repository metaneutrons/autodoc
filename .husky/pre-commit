#!/bin/sh

echo "🔍 Pre-commit checks..."

# Check if only non-code files are changed
changed_files=$(git diff --cached --name-only)
code_files=$(echo "$changed_files" | grep -v -E '\.(md|yml|yaml|json|txt)$|^\.github/|^docs/|^README|^LICENSE|^CHANGELOG')

if [ -z "$code_files" ]; then
    echo "📝 Only documentation/config files changed, skipping Rust compilation"
    echo "✅ Pre-commit checks passed"
    exit 0
fi

echo "📦 Checking Rust compilation..."

# Auto-format Rust code and check if changes were made
echo "🎨 Auto-formatting Rust code..."
if ! cargo fmt --all; then
    echo "❌ Cargo fmt failed"
    exit 1
fi

# Check if formatting made changes and add them
if ! git diff --quiet; then
    echo "📝 Formatting changes applied, adding to commit..."
    git add -u
else
    echo "✅ Code already properly formatted"
fi

# Check if Rust compiles without errors
if ! cargo check --quiet; then
    echo "❌ Rust compilation failed. Fix errors before committing."
    exit 1
fi

# Run Clippy linting
echo "🔍 Running Clippy linter..."
if ! cargo clippy -- -D warnings; then
    echo "❌ Clippy found issues. Fix them before committing."
    exit 1
fi

echo "✅ Rust compilation successful"
echo "✅ Pre-commit checks passed"
